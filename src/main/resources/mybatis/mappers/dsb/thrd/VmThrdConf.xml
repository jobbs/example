<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="ncis.sql.dsb.thrd.vmThrdConf">



	<select id="selectVmThrdConfList" parameterType="ncis.dsb.thrd.thrdConf.vo.VmThrdConfSearchVo" resultType="ncis.dsb.thrd.thrdConf.vo.VmThrdConfVo">
		/*ncis.sql.dsb.thrd.vmThrdConf.selectVmThrdConfList*/


			SELECT A.PATH
					, A.VM_NM
					, A.VM_ID
					, A.VM_SEQ
					, A.VM_COMP_ID
					, MAX(CASE WHEN B.IDX_ITM_ID='0' THEN B.CONF_CONT_CNT END) SERVER_STAT_CONT_CNT
					, MAX(CASE WHEN B.IDX_ITM_ID='0' THEN B.CONF_CMPR_STDR END) SERVER_STAT_CMPR_STDR

					, MAX(CASE WHEN B.IDX_ITM_ID='11' AND B.THRES_GRD_ID='02' THEN B.THRES_CONF_VL END)  CRITICAL_CPU_USE_RT_VL
					, MAX(CASE WHEN B.IDX_ITM_ID='11' AND B.THRES_GRD_ID='02' THEN B.CONF_CMPR_STDR END)  CRITICAL_CPU_USE_RT_CMPR_STDR
					, MAX(CASE WHEN B.IDX_ITM_ID='11' AND B.THRES_GRD_ID='02' THEN B.CONF_CONT_CNT END)  CRITICAL_CPU_USE_RT_CONT_CNT

					, MAX(CASE WHEN B.IDX_ITM_ID='11' AND B.THRES_GRD_ID='03' THEN B.THRES_CONF_VL END)  MAJOR_CPU_USE_RT_VL
					, MAX(CASE WHEN B.IDX_ITM_ID='11' AND B.THRES_GRD_ID='03' THEN B.CONF_CMPR_STDR END ) MAJOR_CPU_USE_RT_CMPR_STDR
					, MAX(CASE WHEN B.IDX_ITM_ID='11' AND B.THRES_GRD_ID='03' THEN B.CONF_CONT_CNT END ) MAJOR_CPU_USE_RT_CONT_CNT

					, MAX(CASE WHEN B.IDX_ITM_ID='12' AND B.THRES_GRD_ID='02' THEN B.THRES_CONF_VL END)  CRITICAL_CPU_VRLZ_RT_VL
					, MAX(CASE WHEN B.IDX_ITM_ID='12' AND B.THRES_GRD_ID='02' THEN B.CONF_CMPR_STDR END)  CRITICAL_CPU_VRLZ_RT_CMPR_STDR
					, MAX(CASE WHEN B.IDX_ITM_ID='12' AND B.THRES_GRD_ID='02' THEN B.CONF_CONT_CNT END)  CRITICAL_CPU_VRLZ_RT_CONT_CNT

					, MAX(CASE WHEN B.IDX_ITM_ID='12' AND B.THRES_GRD_ID='03' THEN B.THRES_CONF_VL END)  MAJOR_CPU_VRLZ_RT_VL
					, MAX(CASE WHEN B.IDX_ITM_ID='12' AND B.THRES_GRD_ID='03' THEN B.CONF_CMPR_STDR END)  MAJOR_CPU_VRLZ_RT_CMPR_STDR
					, MAX(CASE WHEN B.IDX_ITM_ID='12' AND B.THRES_GRD_ID='03' THEN B.CONF_CONT_CNT END)  MAJOR_CPU_VRLZ_RT_CONT_CNT

					, MAX(CASE WHEN B.IDX_ITM_ID='21' AND B.THRES_GRD_ID='02' THEN B.THRES_CONF_VL END)  CRITICAL_MEM_USE_RT_VL
					, MAX(CASE WHEN B.IDX_ITM_ID='21' AND B.THRES_GRD_ID='02' THEN B.CONF_CMPR_STDR END)  CRITICAL_MEM_USE_RT_CMPR_STDR
					, MAX(CASE WHEN B.IDX_ITM_ID='21' AND B.THRES_GRD_ID='02' THEN B.CONF_CONT_CNT END)  CRITICAL_MEM_USE_RT_CONT_CNT

					, MAX(CASE WHEN B.IDX_ITM_ID='21' AND B.THRES_GRD_ID='03' THEN B.THRES_CONF_VL END)  MAJOR_MEM_USE_RT_VL
					, MAX(CASE WHEN B.IDX_ITM_ID='21' AND B.THRES_GRD_ID='03' THEN B.CONF_CMPR_STDR END)  MAJOR_MEM_USE_RT_CMPR_STDR
					, MAX(CASE WHEN B.IDX_ITM_ID='21' AND B.THRES_GRD_ID='03' THEN B.CONF_CONT_CNT END)  MAJOR_MEM_USE_RT_CONT_CNT

					, MAX(CASE WHEN B.IDX_ITM_ID='22' AND B.THRES_GRD_ID='02' THEN B.THRES_CONF_VL END)  CRITICAL_MEM_VRLZ_RT_VL
					, MAX(CASE WHEN B.IDX_ITM_ID='22' AND B.THRES_GRD_ID='02' THEN B.CONF_CMPR_STDR END)  CRITICAL_MEM_VRLZ_RT_CMPR_STDR
					, MAX(CASE WHEN B.IDX_ITM_ID='22' AND B.THRES_GRD_ID='02' THEN B.CONF_CONT_CNT END)  CRITICAL_MEM_VRLZ_RT_CONT_CNT

					, MAX(CASE WHEN B.IDX_ITM_ID='22' AND B.THRES_GRD_ID='03' THEN B.THRES_CONF_VL END)  MAJOR_MEM_VRLZ_RT_VL
					, MAX(CASE WHEN B.IDX_ITM_ID='22' AND B.THRES_GRD_ID='03' THEN B.CONF_CMPR_STDR END)  MAJOR_MEM_VRLZ_RT_CMPR_STDR
					, MAX(CASE WHEN B.IDX_ITM_ID='22' AND B.THRES_GRD_ID='03' THEN B.CONF_CONT_CNT END)  MAJOR_MEM_VRLZ_RT_CONT_CNT
					, C.USER_NM
					, C.CNT USER_CNT
					, D.GRD_NM
			FROM
			 (SELECT DISTINCT D.INSTITUTION_NM||'>' || B.JOB_NM PATH,
				C.VM_NM,
				C.VM_SEQ,
				C.VM_ID,
				C.VM_COMP_ID
			  FROM
			  	<if test='!allJobAuth'>
			  		CM_JOB_USER A,
			  	</if>

			  		CM_JOB B, RC_VM C, CM_INSTITUTION D, RC_VM_JOB E
			  WHERE 1=1
			  <if test='!allJobAuth'>
			  	AND  A.USER_ID = #{searchUserId}
			  	AND  A.JOB_ID = B.JOB_ID
			  </if>
			  AND  B.JOB_ID = E.JOB_ID
			  AND  E.VM_SEQ = C.VM_SEQ
			  /*AND  C.INSTITUTION_ID = D.INSTITUTION_ID*/
			  <if test='institutionId !=null and !"".equals(institutionId)'>
			  	AND B.INSTITUTION_ID =#{institutionId}
			  </if>
			  <if test='jobId !=null and !"".equals(jobId)'>
			  	AND B.JOB_ID =#{jobId}
			  </if>
			  <if test='vmSeq !=null and !"".equals(vmSeq)'>
			  	AND C.VM_SEQ =#{vmSeq}
			  </if>
			  AND  B.INSTITUTION_ID = D.INSTITUTION_ID
			  AND B.USE_YN = 'Y'
			  AND D.USE_YN = 'Y'
			  AND UPPER(C.DEL_YN) = 'N'
			   ) A LEFT JOIN  ST_TRGT_SRVR_THRES_CONF B ON (B.THRES_TRGT_SRVR_SEQ = A.VM_SEQ AND TRGT_SRVR_CL_CD ='01')
			 LEFT JOIN
			(   SELECT THRES_TRGT_SRVR_SEQ, USER_NM, CNT
			FROM (
			SELECT COUNT(1) OVER(PARTITION BY X.DSPTH_CONF_ID) CNT , USER_NM, THRES_TRGT_SRVR_SEQ, ROW_NUMBER() OVER(PARTITION BY THRES_TRGT_SRVR_SEQ ORDER BY USER_NM) SEQ
			FROM ST_DSPTH_CONF X, ST_EVNT_DSPTH_CHARGER Y,  CM_USR Z
			WHERE X.TRGT_SRVR_CL_CD ='01'
			AND X.DSPTH_CONF_ID = Y.DSPTH_CONF_ID
			AND Y.DSPTH_TRGT_ID = Z.USER_ID
			ORDER BY THRES_TRGT_SRVR_SEQ, USER_NM
			) A
			WHERE SEQ =1
			) C ON A.VM_SEQ = C.THRES_TRGT_SRVR_SEQ
			LEFT JOIN (
				SELECT THRES_TRGT_SRVR_SEQ, TRIM(COALESCE(NM1,'')||' ' ||COALESCE(NM2,'')||' ' ||COALESCE(NM3,'')) GRD_NM
				FROM (
				SELECT THRES_TRGT_SRVR_SEQ,
					MAX(CASE WHEN DSPTH_GRD_CD = '01' THEN FN_CODE_NAME('027',DSPTH_GRD_CD) END) NM1,
					MAX(CASE WHEN DSPTH_GRD_CD = '02' THEN FN_CODE_NAME('027',DSPTH_GRD_CD) END) NM2,
					MAX(CASE WHEN DSPTH_GRD_CD = '03' THEN FN_CODE_NAME('027',DSPTH_GRD_CD) END) NM3
				FROM ST_DSPTH_CONF X, ST_DSPTH_GRD Y
				WHERE X.TRGT_SRVR_CL_CD ='01'
				AND X.DSPTH_CONF_ID = Y.DSPTH_CONF_ID
				GROUP BY THRES_TRGT_SRVR_SEQ
				) A
			) D ON A.VM_SEQ = D.THRES_TRGT_SRVR_SEQ
			GROUP BY A.PATH, A.VM_NM,A.VM_ID,A.VM_SEQ, C.USER_NM, C.CNT, D.GRD_NM,A.VM_COMP_ID
			ORDER BY 2
	</select>
	<select id="selectVmThrdConfListCount" parameterType="ncis.dsb.thrd.thrdConf.vo.VmThrdConfSearchVo" resultType="int">
		/* ncis.sql.dsb.thrd.vmThrdConf.selectVmThrdConfListCount */
		SELECT COUNT(DISTINCT(A.PATH, A.VM_NM, A.VM_ID, A.VM_SEQ)) cnt
			FROM
			 (SELECT DISTINCT D.INSTITUTION_NM||'>' || B.JOB_NM||'>'||C.VM_NM PATH,
				C.VM_NM,
				C.VM_SEQ,
				C.VM_ID
			  FROM
			  <if test='!allJobAuth'>
			  	CM_JOB_USER A,
			  </if>
			  	CM_JOB B, RC_VM C, CM_INSTITUTION D, RC_VM_JOB E
			  WHERE 1=1
			  <if test='!allJobAuth'>
			  	AND  A.USER_ID = #{searchUserId}
			  	AND  A.JOB_ID = B.JOB_ID
			  </if>
			  AND  B.JOB_ID = E.JOB_ID
			  AND  E.VM_SEQ = C.VM_SEQ
			  AND  B.INSTITUTION_ID = D.INSTITUTION_ID
			  /*AND  C.INSTITUTION_ID = D.INSTITUTION_ID*/
			  AND B.USE_YN = 'Y'
			  AND D.USE_YN = 'Y'
			  AND UPPER(C.DEL_YN) = 'N'
			  <if test='institutionId !=null and !"".equals(institutionId)'>
			  	AND B.INSTITUTION_ID =#{institutionId}
			  </if>
			  <if test='jobId !=null and !"".equals(jobId)'>
			  	AND B.JOB_ID =#{jobId}
			  </if>
			  <if test='vmSeq !=null and !"".equals(vmSeq)'>
			  	AND C.VM_Seq =#{vmSeq}
			  </if>

			 ) A LEFT JOIN  ST_TRGT_SRVR_THRES_CONF B ON (B.THRES_TRGT_SRVR_SEQ = A.VM_SEQ AND TRGT_SRVR_CL_CD ='01')
	</select>


</mapper>